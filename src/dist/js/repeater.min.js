jQuery((function(e){const t=window.pomatioDependencies||{},r=t.handleFieldVisibility||function(){},a=t.initializeFieldVisibility||function(){};a(),e(document).on("click",".repeater .title",(function(){e(this).closest(".repeater").toggleClass("closed"),e(".CodeMirror").each((function(e,t){t.CodeMirror.refresh()}))})),e(document).on("click touchstart",".repeater-identifier",(function(t){t.preventDefault(),t.stopPropagation();const r=e(this).text().trim();if(!r)return;if(navigator.clipboard&&navigator.clipboard.writeText)return void navigator.clipboard.writeText(r);const a=e("<textarea>");a.val(r),e(this).append(a),a[0].select(),document.execCommand("copy"),a.remove()}));let $set_repeater_identifier=function(e){let t=e.find(".title .repeater-identifier");if(!t.length)return;let r=e.find('input[name="repeater_identifier"]').val();r?t.html(" - ID: "+r):t.html("")},$decode_repeater_value=function(e){if("string"!=typeof e||""===e.trim())return{};try{let t=JSON.parse(e);return t&&"object"==typeof t?t:{}}catch(e){return{}}},$preserve_nested_repeaters=function(e,t){e&&"object"==typeof e&&Object.keys(e).forEach((function(r){if(Object.prototype.hasOwnProperty.call(t,r))return;let a=e[r];a&&"object"==typeof a&&"repeater"===a.type&&(t[r]=a)}))},$update_repeater=function(t){let a=t.children(".repeater"),i=t.parents(".repeater-wrapper").length>0,n=$decode_repeater_value(t.children(".repeater-value").val()),o={};for(let l=0;l<a.length;l++){let p=a[l].classList.contains("default")?"default":"new";$set_repeater_identifier(e(a[l]));let s=a[l].querySelectorAll("input, select, textarea"),c={},f={},u=new Set;for(let t=0;t<s.length;t++){let a=s[t],n=a.getAttribute("data-base-name")||a.getAttribute("name"),o=e(a).parents(".repeater-wrapper").length>1;if("config"!==n&&(i||!o)){if("repeater_identifier"===n||"default_values"===n)c[n]=a.value.trim();else{if("trbl"===a.getAttribute("data-type")){let t=a.getAttribute("data-base-name")||n;if(t&&t.includes("[")&&(t=t.split("[")[0]),u.has(t))continue;u.add(t);const r=e(a).closest(".pomatio-trbl"),i=["top","right","bottom","left"],o={sync:"yes"===r.find(".pomatio-trbl__sync-state").val()?"yes":"no"};for(const e of i){const t=r.find(`.pomatio-trbl__value[name$="[${e}][value]"]`).first().val(),a=r.find(`[name$="[${e}][unit]"]`).first().val();o[e]={value:t?t.trim():"",unit:a||""}}c[t]={value:o,type:"trbl"};continue}if("radio"===a.type&&!a.checked)continue;let t=a.value.trim();if("checkbox"!==a.getAttribute("data-type")&&"toggle"!==a.getAttribute("data-type")||(t=e(a).is(":checked")?"yes":"no"),"select"===a.getAttribute("data-type")&&e(a).prop("multiple")&&(t=e(a).val().join(",")),"font_picker"===a.getAttribute("data-type")){let e=n.match(/\[([^\]]+)\]$/);if(e){let r=e[1];n=n.split("[")[0],f.hasOwnProperty(r)||(f[r]=t),t=f}}c[n]={value:t,type:a.getAttribute("data-type")||""}}r(a)}}if(i||e(a[l]).find(".repeater-wrapper").each((function(){if(e(this).closest(".repeater")[0]!==a[l])return;const t=e(this).children(".repeater-value").last(),r=t.attr("name");r&&(c[r]={value:$decode_repeater_value(t.val()),type:"repeater"})})),!i&&Array.isArray(n[p])&&$preserve_nested_repeaters(n[p][l],c),o.hasOwnProperty(p)||(o[p]=[]),o[p].push(c),t.children(".repeater-value").val(JSON.stringify(o)),i){const e=t.closest(".repeater"),r=e.index(),a=t.find(".repeater-value").attr("name");if(!a)continue;const i=t.parents(".repeater-wrapper").last(),n=e.hasClass("default")?"default":"new";let l=$decode_repeater_value(i.find(".repeater-value").last().val());Array.isArray(l[n])||(l[n]=[]),Object.prototype.hasOwnProperty.call(l[n],r)&&l[n][r]&&"object"==typeof l[n][r]||(l[n][r]={}),l[n][r][a]={value:o,type:"repeater"},i.find(".repeater-value").last().val(JSON.stringify(l))}}};e(document).on("click",".add-new-repeater-item",(function(t){t.preventDefault();let r=e(this),i=r.closest(".repeater-wrapper"),n=parseInt(i.attr("data-limit")),o=i.find("> .repeater").length;if(o>=n)return e(".repeater-limit-warning").length||r.after('<span class="repeater-limit-warning">'+pomatio_framework_repeater.limit+"</span>"),void setTimeout((function(){e(".repeater-limit-warning").remove()}),2e3);let l=r.siblings(".repeater-spinner");l.show();let p=r.siblings('[name="config"]').val();e.ajax({url:pomatio_framework_repeater.ajax_url,type:"POST",data:{action:"pomatio_framework_get_repeater_item_html",config:p,items:o},success:function(e){r.before(e),l.hide()}}),e(document).ajaxComplete((function(){void 0!==e.fn.select2&&e(".pomatio-framework-select.multiple").select2(),void 0!==e.fn.wpColorPicker&&e(".pomatio-framework-color-picker").wpColorPicker(),a()}))})),e(document).on("click",".repeater-wrapper .delete",(function(t){if(t.preventDefault(),!confirm(pomatio_framework_repeater.delete_repeater))return;const r=e(this),a=r.closest(".repeater").hasClass("default")?"default":"new",i=r.closest(".repeater-wrapper");if(!(i.parents(".repeater-wrapper").length>0)){const e=r.closest(".repeater").index();let t=i.find(".repeater-value").last().val();return t=JSON.parse(t),t[a].splice(e,1),i.find(".repeater-value").last().val(JSON.stringify(t)),r.closest(".repeater").remove(),void $update_repeater(i)}i.find(".repeater-value").val(""),r.closest(".repeater").remove(),$update_repeater(i)})),e(document).on("change",".repeater-wrapper input, .repeater-wrapper textarea, .repeater-wrapper select",(function(){const t=e(this);$update_repeater(t.closest(".repeater-wrapper"))})),e(document).on("input",'.repeater-wrapper input[data-type="icon_picker"]',(function(){const t=e(this);$update_repeater(t.closest(".repeater-wrapper"))})),void 0!==e.fn.wpColorPicker&&(e(".pomatio-framework-color-picker").wpColorPicker({change:function(t,r){let a=r.color.toString(),i=e(t.target);i.val(a),$update_repeater(i.closest(".repeater-wrapper"))}}),e(document).ajaxComplete((function(){e(".pomatio-framework-color-picker").wpColorPicker({change:function(t,r){let a=r.color.toString(),i=e(t.target);i.val(a),$update_repeater(i.closest(".repeater-wrapper"))}})}))),void 0!==e.fn.sortable&&e(".repeater-wrapper.sortable").sortable({update:function(t,r){$update_repeater(e(this))}});let $update_repeater_title=function(t){let r=t.closest(".repeater").find(".title span").first(),a=function(t){if(t.is("select")){let r=t.find("option:selected");return r.length>0?r.map((function(){return e(this).text().trim()})).get().filter((function(e){return""!==e})).join(", "):""}return t.val()}(t);a?r.html(" - "+a):r.html("")};e(document).on("keyup change",".repeater .use-for-title",(function(){$update_repeater_title(e(this))}));let $append_to_title=function(){e(".repeater-wrapper .use-for-title").each((function(t,r){$update_repeater_title(e(this))})),e(".repeater-wrapper .repeater").each((function(){$set_repeater_identifier(e(this))}))};$append_to_title(),e(document).ajaxComplete((function(){$append_to_title()})),e(document).on("click",".restore-default",(function(t){t.preventDefault();let r=e(this),a=r.closest(".repeater-wrapper"),i=r.closest(".repeater").find('input[name="default_values"').val();if(i){let e=JSON.parse(i);Object.keys(e).map((function(t){let a=e[t].value;r.closest(".repeater").find("input, select, checkbox, textarea").each((function(){this.getAttribute("name")===t&&(this.value=a)}))})),$update_repeater(a)}})),e(document).on("click",".restore-repeater-defaults",(function(t){if(t.preventDefault(),!confirm(pomatio_framework_repeater.restore_msg))return;let r=e(this),a=r.closest(".repeater-wrapper"),i=r.closest(".repeater-wrapper").find(".repeater-spinner");i.show(),a.find(".repeater.default").remove(),e.ajax({url:ajaxurl,type:"POST",data:{action:"pomatio_framework_restore_repeater_defaults",defaults:r.attr("data-defaults"),fields:r.attr("data-fields"),title:r.attr("data-title")},success:function(e){r.closest(".repeater-wrapper").prepend(e),i.hide(),$update_repeater(a)}})})),e(document).on("click",".clone-repeater",(function(t){t.preventDefault();let r=e(this),a=r.closest(".repeater"),i=r.closest(".repeater-wrapper"),n=a.clone();n.find('input[name="repeater_identifier"]').val($generate_random_string(10,!1)),$set_repeater_identifier(n);let o=n.find(".pomatio-framework-code-editor-html, .pomatio-framework-code-editor-js, .pomatio-framework-code-editor-css");for(let t=0;t<o.length;t++)o[t].id=$generate_random_string(10,!1),e(o).next().remove(),wp.codeEditor.initialize(o[t],settings.codeMirrorSettings);n.hasClass("default")&&(n=n.removeClass("default").addClass("new"),n.find('input[name="default_values"]').remove()),a.after(n),$update_repeater(i)}));let $generate_random_string=function(e=10,t=!0){const r=(t?"0123456789":"")+"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";let a="";for(let t=0;t<e;t++)a+=r[Math.floor(Math.random()*r.length)];return a}}));