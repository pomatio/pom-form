jQuery((function(e){function handleFieldVisibility(t){if(!t.getAttribute("data-dependencies"))return;let r=t.getAttribute("data-dependencies");r=r.replaceAll("'",'"');const a=JSON.parse(r),i=e(t).closest(".repeater"),n=i.length?i:e(document);let l=!1;for(let e of a){let t=!0;for(let r of e){let e=r.field;e=e.replace("field_","");const a=`[data-base-name="${e}"]`;let i=n.find(a);if(i.length||(i=n.find(`[name="${e}"]`)),i.length||(i=n.find(`[name$="[${e}]"]`)),i.length||(i=n.find(`[name$="[${e}][]"]`)),!i.length){t=!1;break}let l="";if(l=i.is(":radio")?i.filter(":checked").val()||"":i.first().val(),!r.values.includes(l)){t=!1;break}}if(t){l=!0;break}}l?e(t).closest(".form-group").show():e(t).closest(".form-group").hide()}function initializeFieldVisibility(){e("[data-dependencies]").each((function(){handleFieldVisibility(this)}))}initializeFieldVisibility(),e(document).on("click",".repeater .title",(function(){e(this).closest(".repeater").toggleClass("closed"),e(".CodeMirror").each((function(e,t){t.CodeMirror.refresh()}))})),e(document).on("click touchstart",".repeater-identifier",(function(t){t.preventDefault(),t.stopPropagation();const r=e(this).text().trim();if(!r)return;if(navigator.clipboard&&navigator.clipboard.writeText)return void navigator.clipboard.writeText(r);const a=e("<textarea>");a.val(r),e(this).append(a),a[0].select(),document.execCommand("copy"),a.remove()}));let $set_repeater_identifier=function(e){let t=e.find(".title .repeater-identifier");if(!t.length)return;let r=e.find('input[name="repeater_identifier"]').val();r?t.html(" - ID: "+r):t.html("")},$update_repeater=function(t){let r=t.children(".repeater"),a=t.parents(".repeater-wrapper").length>0,i={};for(let n=0;n<r.length;n++){let l=r[n].classList.contains("default")?"default":"new";$set_repeater_identifier(e(r[n]));let o=r[n].querySelectorAll("input, select, textarea"),p={},s={};for(let t=0;t<o.length;t++){let r=o[t],i=r.getAttribute("data-base-name")||r.getAttribute("name"),n=e(r).parents(".repeater-wrapper").length>1;if("config"!==i&&(a||!n)){if("repeater_identifier"===i||"default_values"===i)p[i]=r.value.trim();else{if("radio"===r.type&&!r.checked)continue;let t=r.value.trim();if("checkbox"!==r.getAttribute("data-type")&&"toggle"!==r.getAttribute("data-type")||(t=e(r).is(":checked")?"yes":"no"),"select"===r.getAttribute("data-type")&&e(r).prop("multiple")&&(t=e(r).val().join(",")),"font_picker"===r.getAttribute("data-type")){let e=i.match(/\[(.*)\]/)[1];i=i.split("[")[0],s.hasOwnProperty(e)||(s[e]=t),t=s}p[i]={value:t,type:r.getAttribute("data-type")||""}}handleFieldVisibility(r)}}if(i.hasOwnProperty(l)||(i[l]=[]),i[l].push(p),t.children(".repeater-value").val(JSON.stringify(i)),a){const e=t.closest(".repeater").index(),r=t.find(".repeater-value").attr("name"),a=t.parents(".repeater-wrapper").last(),n=a.find(".repeater").hasClass("new")?"new":"default";let l=a.find(".repeater-value").last().val();l=JSON.parse(l),l.hasOwnProperty(n)||(l[n]=[]),l[n].hasOwnProperty(e)||(l[n][e]=[]),l[n][e].hasOwnProperty(r)||(l[n][e][r]=[]),l[n][e][r]={value:i,type:"repeater"},a.find(".repeater-value").last().val(JSON.stringify(l))}}};e(document).on("click",".add-new-repeater-item",(function(t){t.preventDefault();let r=e(this),a=r.closest(".repeater-wrapper"),i=parseInt(a.attr("data-limit")),n=a.find("> .repeater").length;if(n>=i)return e(".repeater-limit-warning").length||r.after('<span class="repeater-limit-warning">'+pomatio_framework_repeater.limit+"</span>"),void setTimeout((function(){e(".repeater-limit-warning").remove()}),2e3);let l=r.siblings(".repeater-spinner");l.show();let o=r.siblings('[name="config"]').val();e.ajax({url:pomatio_framework_repeater.ajax_url,type:"POST",data:{action:"pomatio_framework_get_repeater_item_html",config:o,items:n},success:function(e){r.before(e),l.hide()}}),e(document).ajaxComplete((function(){void 0!==e.fn.select2&&e(".pomatio-framework-select.multiple").select2(),void 0!==e.fn.wpColorPicker&&e(".pomatio-framework-color-picker").wpColorPicker(),initializeFieldVisibility()}))})),e(document).on("click",".repeater-wrapper .delete",(function(t){if(t.preventDefault(),!confirm(pomatio_framework_repeater.delete_repeater))return;const r=e(this),a=r.closest(".repeater").hasClass("default")?"default":"new",i=r.closest(".repeater-wrapper");if(!(i.parents(".repeater-wrapper").length>0)){const e=r.closest(".repeater").index();let t=i.find(".repeater-value").last().val();return t=JSON.parse(t),t[a].splice(e,1),i.find(".repeater-value").last().val(JSON.stringify(t)),r.closest(".repeater").remove(),void $update_repeater(i)}i.find(".repeater-value").val(""),r.closest(".repeater").remove(),$update_repeater(i)})),e(document).on("change",".repeater-wrapper input, .repeater-wrapper textarea, .repeater-wrapper select",(function(){const t=e(this);$update_repeater(t.closest(".repeater-wrapper"))})),e(document).on("change input","input, textarea, select",(function(){e(this).closest(".repeater-wrapper").length||initializeFieldVisibility()})),e(document).on("input",'.repeater-wrapper input[data-type="icon_picker"]',(function(){const t=e(this);$update_repeater(t.closest(".repeater-wrapper"))})),void 0!==e.fn.wpColorPicker&&(e(".pomatio-framework-color-picker").wpColorPicker({change:function(t,r){let a=r.color.toString(),i=e(t.target);i.val(a),$update_repeater(i.closest(".repeater-wrapper"))}}),e(document).ajaxComplete((function(){e(".pomatio-framework-color-picker").wpColorPicker({change:function(t,r){let a=r.color.toString(),i=e(t.target);i.val(a),$update_repeater(i.closest(".repeater-wrapper"))}})}))),void 0!==e.fn.sortable&&e(".repeater-wrapper.sortable").sortable({update:function(t,r){$update_repeater(e(this))}});let $update_repeater_title=function(t){let r=t.closest(".repeater").find(".title span").first(),a=function(t){if(t.is("select")){let r=t.find("option:selected");return r.length>0?r.map((function(){return e(this).text().trim()})).get().filter((function(e){return""!==e})).join(", "):""}return t.val()}(t);a?r.html(" - "+a):r.html("")};e(document).on("keyup change",".repeater .use-for-title",(function(){$update_repeater_title(e(this))}));let $append_to_title=function(){e(".repeater-wrapper .use-for-title").each((function(t,r){$update_repeater_title(e(this))})),e(".repeater-wrapper .repeater").each((function(){$set_repeater_identifier(e(this))}))};$append_to_title(),e(document).ajaxComplete((function(){$append_to_title()})),e(document).on("click",".restore-default",(function(t){t.preventDefault();let r=e(this),a=r.closest(".repeater-wrapper"),i=r.closest(".repeater").find('input[name="default_values"').val();if(i){let e=JSON.parse(i);Object.keys(e).map((function(t){let a=e[t].value;r.closest(".repeater").find("input, select, checkbox, textarea").each((function(){this.getAttribute("name")===t&&(this.value=a)}))})),$update_repeater(a)}})),e(document).on("click",".restore-repeater-defaults",(function(t){if(t.preventDefault(),!confirm(pomatio_framework_repeater.restore_msg))return;let r=e(this),a=r.closest(".repeater-wrapper"),i=r.closest(".repeater-wrapper").find(".repeater-spinner");i.show(),a.find(".repeater.default").remove(),e.ajax({url:ajaxurl,type:"POST",data:{action:"pomatio_framework_restore_repeater_defaults",defaults:r.attr("data-defaults"),fields:r.attr("data-fields"),title:r.attr("data-title")},success:function(e){r.closest(".repeater-wrapper").prepend(e),i.hide(),$update_repeater(a)}})})),e(document).on("click",".clone-repeater",(function(t){t.preventDefault();let r=e(this),a=r.closest(".repeater"),i=r.closest(".repeater-wrapper"),n=a.clone();n.find('input[name="repeater_identifier"]').val($generate_random_string(10,!1)),$set_repeater_identifier(n);let l=n.find(".pomatio-framework-code-editor-html, .pomatio-framework-code-editor-js, .pomatio-framework-code-editor-css");for(let t=0;t<l.length;t++)l[t].id=$generate_random_string(10,!1),e(l).next().remove(),wp.codeEditor.initialize(l[t],settings.codeMirrorSettings);n.hasClass("default")&&(n=n.removeClass("default").addClass("new"),n.find('input[name="default_values"]').remove()),a.after(n),$update_repeater(i)}));let $generate_random_string=function(e=10,t=!0){const r=(t?"0123456789":"")+"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";let a="";for(let t=0;t<e;t++)a+=r[Math.floor(Math.random()*r.length)];return a}}));